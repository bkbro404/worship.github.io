<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message System</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff7e5f;
            --light-color: #f5f7fa;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .message-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }

        .messages-container {
            display: grid;
            gap: 20px;
        }

        .message-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
            position: relative;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-author {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-content {
            margin-bottom: 15px;
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comments-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .comment-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .comment {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profile-page {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }

        .admin-panel {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .users-list,
        .messages-list {
            margin-top: 20px;
        }

        .user-card,
        .admin-message-card {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .online {
            background-color: var(--success-color);
        }

        .offline {
            background-color: #95a5a6;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .syncing {
            background-color: var(--warning-color);
            color: white;
        }

        .synced {
            background-color: var(--success-color);
            color: white;
        }

        .offline-status {
            background-color: var(--error-color);
            color: white;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .comment-form {
                flex-direction: column;
            }
        }

        /* Back Button Style */
        .back-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            font-size: 24px;
            font-weight: bold;
            background: white;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 5px 12px;
            text-decoration: none;
            color: #333;
            z-index: 1000;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .back-btn:hover {
            background: #f0f0f0;
            border-color: #888;
            color: #000;
        }

        h1 {
            margin-top: 60px;
            /* back button को लागि space */
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Login Screen (Only for regular users) -->
        <div id="login-screen" class="container">
            <header>
                <div class="header-content">
                    <div class="logo">Worship Songs</div>
                </div>
            </header>

            <!-- Back Button -->
            <button class="back-btn" onclick="goBack()">←</button>

            <div class="login-form">
                <h2>Login </h2>
                <p>Enter your name and email to continue</p>

                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" placeholder="Your full name">
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Your email address">
                </div>

                <button id="login-btn" class="btn btn-primary" style="width: 100%;">Login</button>
                <div id="sign-in-prompt"
                    style="display: none; margin-top: 15px; padding: 10px; background-color: #fff3cd; border-radius: 4px;">
                    <p>No account found with these details. Would you like to create one?</p>
                    <button id="sign-up-btn" class="btn btn-success">Sign Up</button>
                </div>
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <div id="main-app" style="display: none;">
            <header>
                <div class="header-content container">
                    <div class="logo">Tharu Bhajan</div>
                    <div class="user-info">
                        <div class="avatar" id="user-avatar">U</div>
                        <span id="user-name">User</span>
                        <button id="go-to-admin-btn" class="btn btn-primary" style="display: none;">Admin Panel</button>
                        <button id="logout-btn" class="btn btn-danger">Logout</button>
                    </div>
                </div>
            </header>

            <div class="container">
                <div class="tabs">
                    <div class="tab active" data-tab="messages">Messages</div>
                    <div class="tab" data-tab="profile">My Profile</div>
                    <div class="tab" data-tab="admin" id="admin-tab" style="display: none;">Admin Panel</div>
                </div>

                <!-- Messages Tab -->
                <div class="tab-content active" id="messages-tab">
                    <div class="message-form">
                        <h3>Post a Message</h3>
                        <textarea id="message-input" placeholder="Share your thoughts..."></textarea>
                        <button id="post-message-btn" class="btn btn-primary" style="margin-top: 10px;">Post
                            Message</button>
                    </div>

                    <div class="messages-container" id="messages-container">
                        <!-- Messages will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-content" id="profile-tab">
                    <div class="profile-page">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profile-avatar">U</div>
                            <div>
                                <h2 id="profile-name">User Name</h2>
                                <p id="profile-email">user@example.com</p>
                            </div>
                        </div>

                        <h3>My Messages</h3>
                        <div id="user-messages">
                            <!-- User's messages will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div class="tab-content" id="admin-tab-content">
                    <div class="admin-panel">
                        <h2>Admin Panel</h2>

                        <div class="users-section">
                            <h3>All Users</h3>
                            <div class="users-list" id="users-list">
                                <!-- Users will be dynamically inserted here -->
                            </div>
                        </div>

                        <div class="messages-section">
                            <h3>All Messages</h3>
                            <div class="messages-list" id="admin-messages-list">
                                <!-- All messages will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Status Indicator -->
        <div id="sync-status" class="sync-status offline-status">Offline</div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBq94owD9gAzdhGDohl6igg6Dxe9IdjNzM",
            authDomain: "real-time-chat-a98fa.firebaseapp.com",
            databaseURL: "https://real-time-chat-a98fa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "real-time-chat-a98fa",
            storageBucket: "real-time-chat-a98fa.firebasestorage.app",
            messagingSenderId: "908628994245",
            appId: "1:908628994245:web:87e3a173c176b7244228ac",
            measurementId: "G-0035MD7JGZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // App state
        let currentUser = null;
        let isAdmin = false;
        let isOnline = navigator.onLine;
        let messages = [];
        let users = [];
        let comments = [];

        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginBtn = document.getElementById('login-btn');
        const signUpBtn = document.getElementById('sign-up-btn');
        const signInPrompt = document.getElementById('sign-in-prompt');
        const logoutBtn = document.getElementById('logout-btn');
        const goToAdminBtn = document.getElementById('go-to-admin-btn');
        const messageInput = document.getElementById('message-input');
        const postMessageBtn = document.getElementById('post-message-btn');
        const messagesContainer = document.getElementById('messages-container');
        const userMessagesContainer = document.getElementById('user-messages');
        const adminMessagesList = document.getElementById('admin-messages-list');
        const usersList = document.getElementById('users-list');
        const adminTab = document.getElementById('admin-tab');
        const adminTabContent = document.getElementById('admin-tab-content');
        const syncStatus = document.getElementById('sync-status');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const profileAvatar = document.getElementById('profile-avatar');

        // Check if user is admin (based on specific credentials)
        function isAdminUser(name, email) {
            return name === "Admin" && email === "chaudharybibek806@gmail.com";
        }

        function goBack() {
            window.history.back(); // अघिल्लो पेजमा फर्किन्छ
        }

        // Redirect to userA.html
        function redirectToAdminPage() {
            // Store admin session
            localStorage.setItem('adminSession', JSON.stringify({
                name: "Admin",
                email: "chaudharybibek806@gmail.com",
                isAdmin: true,
                timestamp: Date.now()
            }));
            window.location.href = "userA.html";
        }

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(tab.getAttribute('data-tab') + '-tab').classList.add('active');
            });
        });

        // Generate avatar from name
        function generateAvatar(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        // Check if user exists
        async function checkUserExists(name, email) {
            try {
                const snapshot = await database.ref('users').once('value');
                const users = snapshot.val() || {};

                for (let userId in users) {
                    if (users[userId].name === name && users[userId].email === email) {
                        return userId;
                    }
                }
                return null;
            } catch (error) {
                console.error('Error checking user:', error);
                return null;
            }
        }

        // Create new user
        async function createUser(name, email) {
            try {
                const newUserRef = database.ref('users').push();
                await newUserRef.set({
                    name: name,
                    email: email,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    isAdmin: isAdminUser(name, email)
                });
                return newUserRef.key;
            } catch (error) {
                console.error('Error creating user:', error);
                return null;
            }
        }

        // Login function
        async function login(name, email) {
            try {
                // Check if admin user
                if (isAdminUser(name, email)) {
                    redirectToAdminPage();
                    return true;
                }

                const userId = await checkUserExists(name, email);

                if (userId) {
                    // User exists, log them in
                    currentUser = {
                        id: userId,
                        name: name,
                        email: email
                    };

                    // Check if user is admin from database
                    const userSnapshot = await database.ref('users/' + userId).once('value');
                    const userData = userSnapshot.val();
                    isAdmin = userData.isAdmin || false;

                    // Update UI
                    updateUI();
                    loadMessages();
                    loadUsers();

                    // Show main app, hide login
                    loginScreen.style.display = 'none';
                    mainApp.style.display = 'block';

                    // Store user data locally
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    return true;
                } else {
                    // User doesn't exist, show sign-up prompt
                    signInPrompt.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                return false;
            }
        }

        // Sign up function
        async function signUp(name, email) {
            try {
                // Check if admin user
                if (isAdminUser(name, email)) {
                    redirectToAdminPage();
                    return true;
                }

                const userId = await createUser(name, email);

                if (userId) {
                    currentUser = {
                        id: userId,
                        name: name,
                        email: email
                    };

                    // Update UI
                    updateUI();
                    loadMessages();
                    loadUsers();

                    // Show main app, hide login
                    loginScreen.style.display = 'none';
                    mainApp.style.display = 'block';

                    // Store user data locally
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    return true;
                }
                return false;
            } catch (error) {
                console.error('Sign up error:', error);
                return false;
            }
        }

        // Update UI based on user state
        function updateUI() {
            if (currentUser) {
                userName.textContent = currentUser.name;
                userAvatar.textContent = generateAvatar(currentUser.name);
                profileName.textContent = currentUser.name;
                profileEmail.textContent = currentUser.email;
                profileAvatar.textContent = generateAvatar(currentUser.name);

                // Show admin tab if user is admin
                if (isAdmin) {
                    adminTab.style.display = 'block';
                    goToAdminBtn.style.display = 'block';
                } else {
                    adminTab.style.display = 'none';
                    goToAdminBtn.style.display = 'none';
                }
            }
        }

        // Post a new message
        async function postMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentUser) return;

            try {
                const newMessageRef = database.ref('messages').push();
                await newMessageRef.set({
                    content: content,
                    authorId: currentUser.id,
                    authorName: currentUser.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    isSynced: true
                });

                messageInput.value = '';

                // Also store locally for offline access
                const message = {
                    id: newMessageRef.key,
                    content: content,
                    authorId: currentUser.id,
                    authorName: currentUser.name,
                    timestamp: Date.now(),
                    isSynced: true
                };

                messages.push(message);
                renderMessages();

            } catch (error) {
                console.error('Error posting message:', error);

                // If offline, store message locally
                if (!isOnline) {
                    const message = {
                        id: 'local_' + Date.now(),
                        content: content,
                        authorId: currentUser.id,
                        authorName: currentUser.name,
                        timestamp: Date.now(),
                        isSynced: false
                    };

                    messages.push(message);
                    saveMessagesToLocalStorage();
                    renderMessages();
                    messageInput.value = '';
                }
            }
        }

        // Delete a message
        async function deleteMessage(messageId) {
            if (!currentUser) return;

            try {
                // Check if user owns the message or is admin
                const message = messages.find(m => m.id === messageId);
                if (!message) return;

                if (message.authorId === currentUser.id || isAdmin) {
                    await database.ref('messages/' + messageId).remove();

                    // Remove from local array
                    messages = messages.filter(m => m.id !== messageId);
                    renderMessages();
                    renderUserMessages();
                    if (isAdmin) renderAdminMessages();
                }
            } catch (error) {
                console.error('Error deleting message:', error);
            }
        }

        // Add a comment to a message
        async function addComment(messageId, content) {
            if (!content.trim() || !currentUser) return;

            try {
                const newCommentRef = database.ref('comments/' + messageId).push();
                await newCommentRef.set({
                    content: content,
                    authorId: currentUser.id,
                    authorName: currentUser.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    isSynced: true
                });

                // Also store locally
                const comment = {
                    id: newCommentRef.key,
                    messageId: messageId,
                    content: content,
                    authorId: currentUser.id,
                    authorName: currentUser.name,
                    timestamp: Date.now(),
                    isSynced: true
                };

                if (!comments[messageId]) comments[messageId] = [];
                comments[messageId].push(comment);
                renderMessages();

            } catch (error) {
                console.error('Error adding comment:', error);

                // If offline, store comment locally
                if (!isOnline) {
                    const comment = {
                        id: 'local_' + Date.now(),
                        messageId: messageId,
                        content: content,
                        authorId: currentUser.id,
                        authorName: currentUser.name,
                        timestamp: Date.now(),
                        isSynced: false
                    };

                    if (!comments[messageId]) comments[messageId] = [];
                    comments[messageId].push(comment);
                    saveCommentsToLocalStorage();
                    renderMessages();
                }
            }
        }

        // Load messages from Firebase and local storage
        async function loadMessages() {
            try {
                // Load from Firebase
                const messagesSnapshot = await database.ref('messages').once('value');
                const firebaseMessages = messagesSnapshot.val() || {};

                // Convert to array
                const messagesArray = [];
                for (let id in firebaseMessages) {
                    messagesArray.push({
                        id: id,
                        ...firebaseMessages[id]
                    });
                }

                // Load from local storage
                const localMessages = JSON.parse(localStorage.getItem('messages')) || [];

                // Merge messages, prioritizing Firebase data
                const allMessages = [...messagesArray];

                // Add local messages that aren't in Firebase
                localMessages.forEach(localMsg => {
                    if (!allMessages.find(msg => msg.id === localMsg.id)) {
                        allMessages.push(localMsg);
                    }
                });

                // Sort by timestamp
                messages = allMessages.sort((a, b) => b.timestamp - a.timestamp);

                // Load comments
                const commentsSnapshot = await database.ref('comments').once('value');
                const firebaseComments = commentsSnapshot.val() || {};

                comments = {};
                for (let messageId in firebaseComments) {
                    comments[messageId] = [];
                    for (let commentId in firebaseComments[messageId]) {
                        comments[messageId].push({
                            id: commentId,
                            ...firebaseComments[messageId][commentId]
                        });
                    }
                }

                // Load local comments
                const localComments = JSON.parse(localStorage.getItem('comments')) || {};
                for (let messageId in localComments) {
                    if (!comments[messageId]) comments[messageId] = [];

                    localComments[messageId].forEach(localComment => {
                        if (!comments[messageId].find(c => c.id === localComment.id)) {
                            comments[messageId].push(localComment);
                        }
                    });
                }

                // Sort comments by timestamp
                for (let messageId in comments) {
                    comments[messageId].sort((a, b) => a.timestamp - b.timestamp);
                }

                renderMessages();
                renderUserMessages();
                if (isAdmin) renderAdminMessages();

            } catch (error) {
                console.error('Error loading messages:', error);

                // Fallback to local storage
                messages = JSON.parse(localStorage.getItem('messages')) || [];
                comments = JSON.parse(localStorage.getItem('comments')) || {};

                renderMessages();
                renderUserMessages();
                if (isAdmin) renderAdminMessages();
            }
        }

        // Load users from Firebase
        async function loadUsers() {
            try {
                const usersSnapshot = await database.ref('users').once('value');
                const usersData = usersSnapshot.val() || {};

                users = [];
                for (let id in usersData) {
                    users.push({
                        id: id,
                        ...usersData[id]
                    });
                }

                if (isAdmin) renderUsers();

            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Render messages to the UI
        function renderMessages() {
            if (!messagesContainer) return;

            messagesContainer.innerHTML = '';

            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p>No messages yet. Be the first to post!</p>';
                return;
            }

            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message-card';
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div class="message-author">
                            <div class="avatar">${generateAvatar(message.authorName)}</div>
                            <div>
                                <strong>${message.authorName}</strong>
                                <div class="message-time">${formatTime(message.timestamp)}</div>
                            </div>
                        </div>
                        ${message.authorId === currentUser.id || isAdmin ?
                        `<button class="btn btn-danger delete-message" data-id="${message.id}">Delete</button>` : ''}
                    </div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions">
                        <button class="btn toggle-comments" data-id="${message.id}">Show Comments</button>
                    </div>
                    <div class="comments-section" id="comments-${message.id}" style="display: none;">
                        <div class="comment-form">
                            <input type="text" class="comment-input" placeholder="Add a comment..." id="comment-input-${message.id}">
                            <button class="btn btn-primary add-comment" data-id="${message.id}">Comment</button>
                        </div>
                        <div class="comments-list" id="comments-list-${message.id}">
                            <!-- Comments will be inserted here -->
                        </div>
                    </div>
                `;

                messagesContainer.appendChild(messageElement);
            });

            // Add event listeners
            document.querySelectorAll('.delete-message').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteMessage(e.target.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.toggle-comments').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const messageId = e.target.getAttribute('data-id');
                    const commentsSection = document.getElementById(`comments-${messageId}`);

                    if (commentsSection.style.display === 'none') {
                        commentsSection.style.display = 'block';
                        e.target.textContent = 'Hide Comments';
                        renderComments(messageId);
                    } else {
                        commentsSection.style.display = 'none';
                        e.target.textContent = 'Show Comments';
                    }
                });
            });

            document.querySelectorAll('.add-comment').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const messageId = e.target.getAttribute('data-id');
                    const commentInput = document.getElementById(`comment-input-${messageId}`);
                    addComment(messageId, commentInput.value);
                    commentInput.value = '';
                });
            });
        }

        // Render comments for a specific message
        function renderComments(messageId) {
            const commentsList = document.getElementById(`comments-list-${messageId}`);
            if (!commentsList) return;

            commentsList.innerHTML = '';

            if (!comments[messageId] || comments[messageId].length === 0) {
                commentsList.innerHTML = '<p>No comments yet.</p>';
                return;
            }

            comments[messageId].forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <span><strong>${comment.authorName}</strong></span>
                        <span>${formatTime(comment.timestamp)}</span>
                    </div>
                    <div>${comment.content}</div>
                `;
                commentsList.appendChild(commentElement);
            });
        }

        // Render user's own messages
        function renderUserMessages() {
            if (!userMessagesContainer || !currentUser) return;

            const userMessages = messages.filter(msg => msg.authorId === currentUser.id);

            userMessagesContainer.innerHTML = '';

            if (userMessages.length === 0) {
                userMessagesContainer.innerHTML = '<p>You haven\'t posted any messages yet.</p>';
                return;
            }

            userMessages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message-card';
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div class="message-time">${formatTime(message.timestamp)}</div>
                        <button class="btn btn-danger delete-message" data-id="${message.id}">Delete</button>
                    </div>
                    <div class="message-content">${message.content}</div>
                `;

                userMessagesContainer.appendChild(messageElement);
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-message').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteMessage(e.target.getAttribute('data-id'));
                });
            });
        }

        // Render users in admin panel
        function renderUsers() {
            if (!usersList || !isAdmin) return;

            usersList.innerHTML = '';

            if (users.length === 0) {
                usersList.innerHTML = '<p>No users found.</p>';
                return;
            }

            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'user-card';
                userElement.innerHTML = `
                    <div>
                        <div class="avatar" style="display: inline-block; margin-right: 10px;">${generateAvatar(user.name)}</div>
                        <strong>${user.name}</strong> (${user.email})
                        <div>Joined: ${formatTime(user.createdAt)}</div>
                    </div>
                    <button class="btn btn-danger delete-user" data-id="${user.id}">Remove User</button>
                `;

                usersList.appendChild(userElement);
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-user').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const userId = e.target.getAttribute('data-id');
                    if (confirm('Are you sure you want to remove this user? This will also delete all their messages.')) {
                        try {
                            // Delete user
                            await database.ref('users/' + userId).remove();

                            // Delete user's messages
                            const userMessages = messages.filter(msg => msg.authorId === userId);
                            for (let message of userMessages) {
                                await database.ref('messages/' + message.id).remove();
                            }

                            // Reload data
                            loadMessages();
                            loadUsers();

                        } catch (error) {
                            console.error('Error deleting user:', error);
                        }
                    }
                });
            });
        }

        // Render all messages in admin panel
        function renderAdminMessages() {
            if (!adminMessagesList || !isAdmin) return;

            adminMessagesList.innerHTML = '';

            if (messages.length === 0) {
                adminMessagesList.innerHTML = '<p>No messages found.</p>';
                return;
            }

            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'admin-message-card';
                messageElement.innerHTML = `
                    <div>
                        <div class="avatar" style="display: inline-block; margin-right: 10px;">${generateAvatar(message.authorName)}</div>
                        <strong>${message.authorName}</strong>
                        <div class="message-time">${formatTime(message.timestamp)}</div>
                        <div>${message.content}</div>
                    </div>
                    <button class="btn btn-danger delete-message" data-id="${message.id}">Delete</button>
                `;

                adminMessagesList.appendChild(messageElement);
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-message').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteMessage(e.target.getAttribute('data-id'));
                });
            });
        }

        // Format timestamp to readable date/time
        function formatTime(timestamp) {
            if (!timestamp) return 'Unknown time';

            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

            return date.toLocaleDateString();
        }

        // Save messages to local storage
        function saveMessagesToLocalStorage() {
            localStorage.setItem('messages', JSON.stringify(messages));
        }

        // Save comments to local storage
        function saveCommentsToLocalStorage() {
            localStorage.setItem('comments', JSON.stringify(comments));
        }

        // Sync local data with Firebase when online
        async function syncLocalData() {
            if (!isOnline || !currentUser) return;

            try {
                syncStatus.textContent = 'Syncing...';
                syncStatus.className = 'sync-status syncing';

                // Sync unsynced messages
                const unsyncedMessages = messages.filter(msg => !msg.isSynced);
                for (let message of unsyncedMessages) {
                    if (message.id.startsWith('local_')) {
                        const newMessageRef = database.ref('messages').push();
                        await newMessageRef.set({
                            content: message.content,
                            authorId: message.authorId,
                            authorName: message.authorName,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            isSynced: true
                        });

                        // Update local message ID
                        message.id = newMessageRef.key;
                        message.isSynced = true;
                    }
                }

                // Sync unsynced comments
                for (let messageId in comments) {
                    for (let i = 0; i < comments[messageId].length; i++) {
                        const comment = comments[messageId][i];
                        if (!comment.isSynced) {
                            // If the message ID is local, we need to find its new ID
                            let actualMessageId = messageId;
                            if (messageId.startsWith('local_')) {
                                const originalMessage = messages.find(m => m.id === messageId);
                                if (originalMessage && originalMessage.isSynced) {
                                    actualMessageId = originalMessage.id;
                                }
                            }

                            if (actualMessageId && !actualMessageId.startsWith('local_')) {
                                const newCommentRef = database.ref('comments/' + actualMessageId).push();
                                await newCommentRef.set({
                                    content: comment.content,
                                    authorId: comment.authorId,
                                    authorName: comment.authorName,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    isSynced: true
                                });

                                // Update local comment
                                comment.id = newCommentRef.key;
                                comment.messageId = actualMessageId;
                                comment.isSynced = true;
                            }
                        }
                    }
                }

                // Save updated data to local storage
                saveMessagesToLocalStorage();
                saveCommentsToLocalStorage();

                // Reload data from Firebase to get any updates from other users
                await loadMessages();

                syncStatus.textContent = 'Synced';
                syncStatus.className = 'sync-status synced';

                setTimeout(() => {
                    if (isOnline) {
                        syncStatus.textContent = 'Online';
                        syncStatus.className = 'sync-status synced';
                    }
                }, 2000);

            } catch (error) {
                console.error('Error syncing data:', error);
                syncStatus.textContent = 'Sync Failed';
                syncStatus.className = 'sync-status offline-status';
            }
        }

        // Check if user is logged in from local storage
        function checkLoggedIn() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);

                // Check if user is admin
                database.ref('users/' + currentUser.id).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    if (userData) {
                        isAdmin = userData.isAdmin || false;
                        updateUI();
                        loadMessages();
                        loadUsers();

                        loginScreen.style.display = 'none';
                        mainApp.style.display = 'block';
                    } else {
                        // User no longer exists in database
                        localStorage.removeItem('currentUser');
                        currentUser = null;
                    }
                }).catch(error => {
                    console.error('Error checking user:', error);
                    // Fallback to offline mode
                    updateUI();
                    loadMessages();

                    loginScreen.style.display = 'none';
                    mainApp.style.display = 'block';
                });
            }
        }

        // Event listeners
        loginBtn.addEventListener('click', async () => {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!name || !email) {
                alert('Please enter both name and email');
                return;
            }

            await login(name, email);
        });

        signUpBtn.addEventListener('click', async () => {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!name || !email) {
                alert('Please enter both name and email');
                return;
            }

            await signUp(name, email);
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('currentUser');

            loginScreen.style.display = 'block';
            mainApp.style.display = 'none';
            signInPrompt.style.display = 'none';

            // Clear form
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
        });

        goToAdminBtn.addEventListener('click', () => {
            redirectToAdminPage();
        });

        postMessageBtn.addEventListener('click', postMessage);

        // Allow pressing Enter to post message
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                postMessage();
            }
        });

        // Online/offline detection
        window.addEventListener('online', () => {
            isOnline = true;
            syncStatus.textContent = 'Online';
            syncStatus.className = 'sync-status synced';
            syncLocalData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            syncStatus.textContent = 'Offline';
            syncStatus.className = 'sync-status offline-status';
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            checkLoggedIn();

            // Set initial sync status
            if (isOnline) {
                syncStatus.textContent = 'Online';
                syncStatus.className = 'sync-status synced';
            } else {
                syncStatus.textContent = 'Offline';
                syncStatus.className = 'sync-status offline-status';
            }

            // Set up real-time listeners for messages and comments
            if (currentUser) {
                database.ref('messages').on('value', (snapshot) => {
                    if (isOnline) {
                        loadMessages();
                    }
                });

                database.ref('comments').on('value', (snapshot) => {
                    if (isOnline) {
                        loadMessages();
                    }
                });

                if (isAdmin) {
                    database.ref('users').on('value', (snapshot) => {
                        if (isOnline) {
                            loadUsers();
                        }
                    });
                }
            }
        });

        // Temporary function to create admin user - RUN THIS ONCE THEN REMOVE
        async function createAdminUser() {
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                const users = snapshot.val() || {};

                // Check if admin already exists
                let adminExists = false;
                for (let userId in users) {
                    if (users[userId].email === "chaudharybibek806@gmail.com") {
                        adminExists = true;
                        // Update existing user to admin
                        await database.ref('users/' + userId).update({
                            isAdmin: true,
                            name: "Admin"
                        });
                        console.log("Existing user updated to admin");
                        break;
                    }
                }

                if (!adminExists) {
                    // Create new admin user
                    const newAdminRef = usersRef.push();
                    await newAdminRef.set({
                        name: "Admin",
                        email: "chaudharybibek806@gmail.com",
                        createdAt: Date.now(),
                        isAdmin: true
                    });
                    console.log("New admin user created with ID:", newAdminRef.key);
                }

                alert("Admin user created/updated successfully!");
            } catch (error) {
                console.error("Error creating admin user:", error);
            }
        }


        // Uncomment the line below to create admin user, then refresh page, then comment it back
        // createAdminUser();
    </script>
</body>

</html>